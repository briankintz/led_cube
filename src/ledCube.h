#ifndef LED_CUBE_H
#define LED_CUBE_H

#define BIT(n, v) ((v & (1 << n)) >> n)

#define NUM_ANIMATIONS 15

/* Struct to contain a single layer of a frame
 *
 * Consists of 3 integers which represent a bitwise mapping
 * of the LED's that are on in the layer for all three colors.
 *
 * An LED's bit position is its position in the flattened 2D
 * grid in column-major, i.e. 4 * (col - 1) + (row - 1), with row and column
 * matching to the silkscreen on the PCB.
 *
 * Ex:  (2, 3) = 4 * (2 - 1) + (3 - 1) = Bit 6
 */
typedef struct {
    unsigned short R;
    unsigned short G;
    unsigned short B;
} Layer;

/*  Struct to contain a single frame of an animation
 *
 *  Consists of 4 layers and the length of time
 *  for which the frame should be displayed
 */
typedef struct {
    unsigned short DisplayMS;

    Layer L1;
    Layer L2;
    Layer L3;
    Layer L4;
} Frame;

/* Struct to contain an animation
 *
 * Consists of the animation length in number of frames,
 * the number of times the animation will repeat, a
 * function pointer (may be null) to a function that will
 * set the next frame, and an array of the frames that make
 * up the animation (for staticly defined animations).
 */
typedef struct {
    unsigned short Length;
    unsigned short Iterations;
    
    void (*GetNextFrame)(const unsigned int i, Frame *current);
    
    Frame Frames[40];
} Animation;

// Animation generation functions
void randB2W_GetNextFrame(const unsigned int i, Frame *current);
void random_GetNextFrame(const unsigned int i, Frame *current);
void randCol_GetNextFrame(const unsigned int i, Frame *current);
void pulse_GetNextFrame(const unsigned int i, Frame *current);
void snake_GetNextFrame(const unsigned int i, Frame *current);

// Animation lookup table
static const Animation animations[NUM_ANIMATIONS] = {
    { // solid color series
        .Iterations = 1,
        .Length = 8,
        .Frames = {
            { 100, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 },
            { 500, 65535, 0, 0, 65535, 0, 0, 65535, 0, 0, 65535, 0, 0 },
            { 500, 65535, 0, 65535, 65535, 0, 65535, 65535, 0, 65535, 65535, 0, 65535 },
            { 500, 65535, 65535, 65535, 65535, 65535, 65535, 65535, 65535, 65535, 65535, 65535, 65535 },
            { 500, 65535, 65535, 0, 65535, 65535, 0, 65535, 65535, 0, 65535, 65535, 0 },
            { 500, 0, 65535, 0, 0, 65535, 0, 0, 65535, 0, 0, 65535, 0 },
            { 500, 0, 65535, 65535, 0, 65535, 65535, 0, 65535, 65535, 0, 65535, 65535 },
            { 500, 0, 0, 65535, 0, 0, 65535, 0, 0, 65535, 0, 0, 65535 }
        }
    },

    { // random column
        .Iterations = 1,
        .Length = 200,
        .GetNextFrame = randCol_GetNextFrame
    },

    { // rotate green plane
        .Iterations = 6,
        .Length = 6,
        .Frames = {
            { 100, 0, 61440, 0, 0, 3840, 0, 0, 240, 0, 0, 15, 0 },
            { 100, 0, 3840, 0, 0, 3840, 0, 0, 240, 0, 0, 240, 0 },
            { 100, 0, 240, 0, 0, 240, 0, 0, 3840, 0, 0, 3840, 0 },
            { 100, 0, 15, 0, 0, 240, 0, 0, 3840, 0, 0, 61440, 0 },
            { 100, 0, 0, 0, 0, 255, 0, 0, 65280, 0, 0, 0, 0 },
            { 100, 0, 0, 0, 0, 65280, 0, 0, 255, 0, 0, 0, 0 }
        }
    },

    { // expand from center
        .Iterations = 2,
        .Length = 10,
        .Frames = {
            { 250, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 },
            { 250, 0, 0, 0, 1632, 0, 0, 1632, 0, 0, 0, 0, 0 },
            { 250, 1632, 0, 0, 28662, 1632, 1632, 28662, 1632, 1632, 1632, 0, 0 },
            { 250, 28662, 1632, 1632, 65535, 27030, 28662, 65535, 27030, 28662, 28662, 1632, 1632 },
            { 250, 28662, 27030, 28662, 63903, 38505, 63903, 63903, 38505, 63903, 28662, 27030, 28662 },
            { 250, 27030, 1632, 27030, 36873, 28662, 38505, 36873, 28662, 38505, 27030, 1632, 27030 },
            { 250, 0, 28662, 1632, 1632, 65535, 27030, 1632, 65535, 27030, 0, 28662, 1632 },
            { 250, 1632, 28662, 27030, 27030, 63903, 38505, 27030, 63903, 38505, 1632, 28662, 27030 },
            { 250, 27030, 27030, 1632, 36873, 36873, 27030, 36873, 36873, 27030, 27030, 27030, 1632 },
            { 250, 0, 0, 27030, 0, 0, 36873, 0, 0, 36873, 0, 0, 27030 }
        }
    },

    { // random
        .Iterations = 1,
        .Length = 200,
        .GetNextFrame = random_GetNextFrame
    },

    { // rotate blue plane
        .Iterations = 6,
        .Length = 6,
        .Frames = {
            { 100, 0, 0, 4680, 0, 0, 4680, 0, 0, 4680, 0, 0, 4680 },
            { 100, 0, 0, 8772, 0, 0, 8772, 0, 0, 8772, 0, 0, 8772 },
            { 100, 0, 0, 17442, 0, 0, 17442, 0, 0, 17442, 0, 0, 17442 },
            { 100, 0, 0, 33825, 0, 0, 33825, 0, 0, 33825, 0, 0, 33825 },
            { 100, 0, 0, 3120, 0, 0, 3120, 0, 0, 3120, 0, 0, 3120 },
            { 100, 0, 0, 960, 0, 0, 960, 0, 0, 960, 0, 0, 960 }
        }
    },

    { // fireworks
        .Iterations = 2,
        .Length = 33,
        .Frames = {
            // red -> blue/green
            { 100, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 },
            { 100, 1024, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 },
            { 100, 0, 0, 0, 1024, 0, 0, 0, 0, 0, 0, 0, 0 },
            { 100, 0, 0, 0, 0, 0, 0, 1024, 0, 0, 0, 0, 0 },
            { 100, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1024, 0 },

            { 100, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 10336, 49792 },
            { 100, 0, 0, 0, 0, 0, 0, 0, 32896, 32768, 0, 8202, 265 },
            { 100, 0, 0, 0, 0, 32896, 32768, 0, 8202, 265, 0, 0, 0 },
            { 100, 0, 32896, 32768, 0, 8202, 265, 0, 0, 0, 0, 0, 0 },
            { 100, 0, 8202, 265, 0, 0, 0, 0, 0, 0, 0, 0, 0 },
            { 100, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 },

            // white -> red/yellow
            { 100, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 },
            { 100, 32, 32, 32, 0, 0, 0, 0, 0, 0, 0, 0, 0 },
            { 100, 0, 0, 0, 32, 32, 32, 0, 0, 0, 0, 0, 0 },
            { 100, 0, 0, 0, 0, 0, 0, 32, 32, 32, 0, 0, 0 },
            { 100, 0, 0, 0, 0, 0, 0, 0, 0, 0, 32, 32, 32 },

            { 100, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1351, 1348, 0 },
            { 100, 0, 0, 0, 0, 0, 0, 259, 256, 0, 17416, 16392, 0 },
            { 100, 0, 0, 0, 259, 256, 0, 18440, 16392, 0, 0, 0, 0 },
            { 100, 259, 256, 0, 18440, 16392, 0, 0, 0, 0, 0, 0, 0 },
            { 100, 18440, 16392, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 },
            { 100, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 },

            // green -> purple/cyan
            { 100, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 },
            { 100, 0, 512, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 },
            { 100, 0, 0, 0, 0, 512, 0, 0, 0, 0, 0, 0, 0 },
            { 100, 0, 0, 0, 0, 0, 0, 0, 512, 0, 0, 0, 0 },
            { 100, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 512, 0 },

            { 100, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5168, 8256, 13424 },
            { 100, 0, 0, 0, 0, 0, 0, 4097, 8196, 12293, 2050, 128, 2178 },
            { 100, 0, 0, 0, 4097, 8196, 12293, 2050, 128, 2178, 0, 0, 0 },
            { 100, 4097, 8196, 12293, 2050, 128, 2178, 0, 0, 0, 0, 0, 0 },
            { 100, 2050, 128, 2178, 0, 0, 0, 0, 0, 0, 0, 0, 0 },
            { 100, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 },
        }
    },

    { // swinging plane
        .Iterations = 2,
        .Length = 24,
        .Frames = {
            { 150, 0, 0, 0, 0, 0, 0, 0, 0, 0, 65535, 0, 0 },
            { 150, 0, 0, 0, 0, 0, 0, 65520, 0, 0, 15, 0, 0 },
            { 150, 0, 0, 0, 65280, 0, 0, 240, 0, 0, 15, 0, 0 },
            { 150, 61440, 0, 0, 3840, 0, 0, 240, 0, 0, 15, 0, 0 },
            { 150, 3840, 0, 0, 3840, 0, 0, 240, 0, 0, 15, 0, 0 },
            { 150, 240, 0, 0, 240, 0, 0, 240, 0, 0, 15, 0, 0 },
            { 150, 15, 0, 0, 15, 0, 0, 15, 0, 0, 15, 0, 0 },
            { 150, 15, 0, 0, 240, 0, 0, 240, 0, 0, 240, 0, 0 },
            { 150, 15, 0, 0, 240, 0, 0, 3840, 0, 0, 3840, 0, 0 },
            { 150, 15, 0, 0, 240, 0, 0, 3840, 0, 0, 61440, 0, 0 },
            { 150, 15, 0, 0, 240, 0, 0, 65280, 0, 0, 0, 0, 0 },
            { 150, 15, 0, 0, 65520, 0, 0, 0, 0, 0, 0, 0, 0 },
            { 150, 65535, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 },
            { 150, 61440, 0, 0, 4095, 0, 0, 0, 0, 0, 0, 0, 0 },
            { 150, 61440, 0, 0, 3840, 0, 0, 255, 0, 0, 0, 0, 0 },
            { 150, 61440, 0, 0, 3840, 0, 0, 240, 0, 0, 15, 0, 0 },
            { 150, 61440, 0, 0, 3840, 0, 0, 240, 0, 0, 240, 0, 0 },
            { 150, 61440, 0, 0, 3840, 0, 0, 3840, 0, 0, 3840, 0, 0 },
            { 150, 61440, 0, 0, 61440, 0, 0, 61440, 0, 0, 61440, 0, 0 },
            { 150, 3840, 0, 0, 3840, 0, 0, 3840, 0, 0, 61440, 0, 0 },
            { 150, 240, 0, 0, 240, 0, 0, 3840, 0, 0, 61440, 0, 0 },
            { 150, 15, 0, 0, 240, 0, 0, 3840, 0, 0, 61440, 0, 0 },
            { 150, 0, 0, 0, 255, 0, 0, 3840, 0, 0, 61440, 0, 0 },
            { 150, 0, 0, 0, 0, 0, 0, 4095, 0, 0, 61440, 0, 0 }
        }
    },

    { // vertical slider (rgb)
        .Iterations = 4,
        .Length = 8,
        .Frames = {
            { 250, 0, 0, 0, 0, 0, 0, 0, 0, 0, 65535, 0, 0 },
            { 250, 0, 0, 0, 0, 0, 0, 65535, 0, 0, 0, 0, 0 },
            { 250, 0, 0, 0, 65535, 0, 0, 0, 0, 0, 0, 65535, 0 },
            { 250, 65535, 0, 0, 0, 0, 0, 0, 65535, 0, 0, 0, 0 },
            { 250, 0, 0, 0, 0, 65535, 0, 0, 0, 0, 0, 0, 65535 },
            { 250, 0, 65535, 0, 0, 0, 0, 0, 0, 65535, 0, 0, 0 },
            { 250, 0, 0, 0, 0, 0, 65535, 0, 0, 0, 0, 0, 0 },
            { 250, 0, 0, 65535, 0, 0, 0, 0, 0, 0, 0, 0, 0 }
        }
    },

    { // pulse
        .Iterations = 1,
        .Length = 903,
        .GetNextFrame = pulse_GetNextFrame
    },

    { // cube frame
        .Iterations = 2,
        .Length = 8,
        .Frames = {
            { 250, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 },
            { 500, 63903, 0, 0, 36873, 0, 0, 36873, 0, 0, 63903, 0, 0 },
            { 500, 0, 63903, 0, 0, 36873, 0, 0, 36873, 0, 0, 63903, 0 },
            { 500, 0, 0, 63903, 0, 0, 36873, 0, 0, 36873, 0, 0, 63903 },
            { 500, 63903, 63903, 0, 36873, 36873, 0, 36873, 36873, 0, 63903, 63903, 0 },
            { 500, 0, 63903, 63903, 0, 36873, 36873, 0, 36873, 36873, 0, 63903, 63903 },
            { 500, 63903, 0, 63903, 36873, 0, 36873, 36873, 0, 36873, 63903, 0, 63903 },
            { 500, 63903, 63903, 63903, 36873, 36873, 36873, 36873, 36873, 36873, 63903, 63903, 63903 }
        }
    },

    { // horizontal slider (cmy)
        .Iterations = 4,
        .Length = 8,
        .Frames = {
            { 250, 0, 4369, 4369, 0, 4369, 4369, 0, 4369, 4369, 0, 4369, 4369 },
            { 250, 0, 8738, 8738, 0, 8738, 8738, 0, 8738, 8738, 0, 8738, 8738 },
            { 250, 4369, 17476, 21845, 4369, 17476, 21845, 4369, 17476, 21845, 4369, 17476, 21845 },
            { 250, 8738, 34952, 43690, 8738, 34952, 43690, 8738, 34952, 43690, 8738, 34952, 43690 },
            { 250, 21845, 4369, 17476, 21845, 4369, 17476, 21845, 4369, 17476, 21845, 4369, 17476 },
            { 250, 43690, 8738, 34952, 43690, 8738, 34952, 43690, 8738, 34952, 43690, 8738, 34952 },
            { 250, 17476, 17476, 0, 17476, 17476, 0, 17476, 17476, 0, 17476, 17476, 0 },
            { 250, 34952, 34952, 0, 34952, 34952, 0, 34952, 34952, 0, 34952, 34952, 0 }
        }
    },

    { // black to white random
        .Iterations = 1,
        .Length = 385,
        .GetNextFrame = randB2W_GetNextFrame
    },

    { // diagonal slider 1
        .Iterations = 3,
        .Length = 40,
        .Frames = {
            { 100, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0 },
            { 100, 0, 0, 0, 0, 0, 0, 1, 0, 0, 18, 0, 0 },
            { 100, 0, 0, 0, 1, 0, 0, 18, 0, 0, 292, 0, 0 },
            { 100, 1, 0, 0, 18, 0, 0, 292, 0, 0, 4680, 0, 0 },
            { 100, 18, 0, 0, 292, 0, 0, 4680, 0, 0, 9344, 0, 0 },
            { 100, 292, 0, 0, 4680, 0, 0, 9344, 0, 0, 18432, 0, 0 },
            { 100, 4680, 0, 0, 9344, 0, 0, 18432, 0, 0, 32768, 0, 0 },
            { 100, 9344, 0, 0, 18432, 0, 0, 32768, 0, 0, 0, 0, 0 },
            { 100, 18432, 0, 0, 32768, 0, 0, 0, 0, 0, 0, 0, 0 },
            { 100, 32768, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 },

            { 100, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4096, 4096, 0 },
            { 100, 0, 0, 0, 0, 0, 0, 4096, 4096, 0, 8448, 8448, 0 },
            { 100, 0, 0, 0, 4096, 4096, 0, 8448, 8448, 0, 16912, 16912, 0 },
            { 100, 4096, 4096, 0, 8448, 8448, 0, 16912, 16912, 0, 33825, 33825, 0 },
            { 100, 8448, 8448, 0, 16912, 16912, 0, 33825, 33825, 0, 2114, 2114, 0 },
            { 100, 16912, 16912, 0, 33825, 33825, 0, 2114, 2114, 0, 132, 132, 0 },
            { 100, 33825, 33825, 0, 2114, 2114, 0, 132, 132, 0, 8, 8, 0 },
            { 100, 2114, 2114, 0, 132, 132, 0, 8, 8, 0, 0, 0, 0 },
            { 100, 132, 132, 0, 8, 8, 0, 0, 0, 0, 0, 0, 0 },
            { 100, 8, 8, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 },

            { 100, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 32768 },
            { 100, 0, 0, 0, 0, 0, 0, 0, 0, 32768, 0, 0, 18432 },
            { 100, 0, 0, 0, 0, 0, 32768, 0, 0, 18432, 0, 0, 9344 },
            { 100, 0, 0, 32768, 0, 0, 18432, 0, 0, 9344, 0, 0, 4680 },
            { 100, 0, 0, 18432, 0, 0, 9344, 0, 0, 4680, 0, 0, 292 },
            { 100, 0, 0, 9344, 0, 0, 4680, 0, 0, 292, 0, 0, 18 },
            { 100, 0, 0, 4680, 0, 0, 292, 0, 0, 18, 0, 0, 1 },
            { 100, 0, 0, 292, 0, 0, 18, 0, 0, 1, 0, 0, 0 },
            { 100, 0, 0, 18, 0, 0, 1, 0, 0, 0, 0, 0, 0 },
            { 100, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0 },

            { 100, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 8, 0 },
            { 100, 0, 0, 0, 0, 0, 0, 0, 8, 0, 0, 132, 0 },
            { 100, 0, 0, 0, 0, 8, 0, 0, 132, 0, 0, 2114, 0 },
            { 100, 0, 8, 0, 0, 132, 0, 0, 2114, 0, 0, 33825, 0 },
            { 100, 0, 132, 0, 0, 2114, 0, 0, 33825, 0, 0, 16912, 0 },
            { 100, 0, 2114, 0, 0, 33825, 0, 0, 16912, 0, 0, 8448, 0 },
            { 100, 0, 33825, 0, 0, 16912, 0, 0, 8448, 0, 0, 4096, 0 },
            { 100, 0, 16912, 0, 0, 8448, 0, 0, 4096, 0, 0, 0, 0 },
            { 100, 0, 8448, 0, 0, 4096, 0, 0, 0, 0, 0, 0, 0 },
            { 100, 0, 4096, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 }
        }
    },

    { // snake
        .Iterations = 1,
        .Length = 1024,
        .GetNextFrame = snake_GetNextFrame
    }
};

#endif

void writeLayer(int i, const Layer *l);
void writeRed(unsigned short value);
void writeGreen(unsigned short value);
void writeBlue(unsigned short value);